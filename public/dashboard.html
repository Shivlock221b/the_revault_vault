<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Digital Gold Dashboard</title>
    <!-- Tailwind CSS via CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Identity Services for OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body class="bg-gray-100">
    <nav class="bg-yellow-500 p-4 flex justify-between items-center">
      <h1 class="text-white text-xl font-bold">Digital Gold Rewards</h1>
      <button id="signout-btn" class="hidden text-white bg-red-500 px-3 py-1 rounded">Sign Out</button>
    </nav>
    <main class="max-w-4xl mx-auto p-4">
      <!-- Sign‑in container shown when user is not authenticated -->
      <div id="signin-container" class="text-center mt-8">
        <div id="g_id_signin"></div>
        <p class="text-gray-600 mt-2">Sign in with Google to view your rewards.</p>
      </div>
      <!-- Dashboard container hidden by default until user logs in -->
      <div id="dashboard" class="hidden">
        <h2 class="text-2xl font-bold mb-4">Welcome, <span id="user-name"></span></h2>
        <!-- Summary cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 bg-white rounded shadow">
            <h3 class="text-sm text-gray-500">Total Gold (g)</h3>
            <p class="text-2xl font-bold" id="total-grams">0</p>
          </div>
          <div class="p-4 bg-white rounded shadow">
            <h3 class="text-sm text-gray-500">Current Value (₹)</h3>
            <p class="text-2xl font-bold" id="total-value">0</p>
          </div>
          <div class="p-4 bg-white rounded shadow">
            <h3 class="text-sm text-gray-500">Redeemable (g)</h3>
            <p class="text-2xl font-bold" id="redeemable-grams">0</p>
          </div>
        </div>
        <!-- Progress bar -->
        <div class="mt-4">
          <h3 class="text-lg font-semibold">Progress to next milestone</h3>
          <div class="w-full bg-gray-300 rounded-full h-4 mt-2">
            <div id="progress-bar" class="bg-yellow-500 h-4 rounded-full" style="width: 0%"></div>
          </div>
          <p class="text-sm text-gray-600 mt-1">
            <span id="current-grams">0</span>g / <span id="next-milestone">1</span>g
          </p>
        </div>
        <!-- Orders list -->
        <div class="mt-8">
          <h3 class="text-xl font-semibold mb-2">Your Orders</h3>
          <div class="overflow-auto max-h-64">
            <table class="min-w-full bg-white rounded shadow">
              <thead class="bg-gray-200">
                <tr>
                  <th class="py-2 px-4 text-left">Date</th>
                  <th class="py-2 px-4 text-left">Order</th>
                  <th class="py-2 px-4 text-left">Gold (g)</th>
                </tr>
              </thead>
              <tbody id="orders-table" class="text-sm"></tbody>
            </table>
          </div>
        </div>
        <!-- Redemption form -->
        <div class="mt-8">
          <h3 class="text-xl font-semibold mb-2">Redeem Gold</h3>
          <div class="bg-white p-4 rounded shadow">
            <p class="text-sm text-gray-600 mb-2">
              Redeemable gold is the amount of gold you can convert to cash immediately.
              All earned gold becomes redeemable after 30 days of the purchase.
            </p>
            <form id="redeem-form" class="space-y-3">
              <div>
                <label for="redeem-grams" class="block text-sm font-medium">Grams to redeem</label>
                <input id="redeem-grams" type="number" min="0" step="0.0001" class="mt-1 p-2 border rounded w-full" required />
              </div>
              <div>
                <label for="redeem-upi" class="block text-sm font-medium">UPI ID</label>
                <input id="redeem-upi" type="text" class="mt-1 p-2 border rounded w-full" required />
              </div>
              <button type="submit" class="bg-yellow-500 text-white px-4 py-2 rounded">Submit Redemption</button>
              <p id="redeem-message" class="text-green-600 mt-2 hidden">Request submitted!</p>
            </form>
          </div>
        </div>
        <!-- Shops grid -->
        <div class="mt-8">
          <h3 class="text-xl font-semibold mb-2">Partner Stores</h3>
          <div id="shops-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <!-- Shop items will be dynamically inserted here -->
          </div>
        </div>
      </div>
    </main>
    <script>
      // Placeholder: update this with your deployed app's host if necessary. Leaving it empty means relative paths.
      const appHost = '';
      let currentUserEmail = null;
      let pendingOrderId = null;

      // Utility: parse query string param
      function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }
      pendingOrderId = getQueryParam('orderId');

      // Initialize Google sign‑in on page load
      window.onload = function() {
        google.accounts.id.initialize({
          client_id: '1081850552329-l4pig8jg9cpctkv3kokpvu4vi72da0bm.apps.googleusercontent.com',
          callback: handleCredentialResponse,
        });
        google.accounts.id.renderButton(
          document.getElementById('g_id_signin'),
          { theme: 'outline', size: 'large' }
        );
      };

      // When Google sign‑in returns a credential, decode and use it
      async function handleCredentialResponse(response) {
        try {
          const payload = JSON.parse(atob(response.credential.split('.')[1]));
          const email = payload.email;
          const displayName = payload.name || '';
          currentUserEmail = email;
          document.getElementById('user-name').textContent = displayName || email;
          // Hide sign‑in UI and show signout button
          document.getElementById('signin-container').classList.add('hidden');
          document.getElementById('signout-btn').classList.remove('hidden');
          // Create or update user
          await fetch(appHost + '/api/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, displayName }),
          });
          // If there is an order to claim, associate it
          if (pendingOrderId) {
            await fetch(appHost + '/api/orders/claim', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId: pendingOrderId, email }),
            });
          }
          // Load the dashboard data
          await loadDashboard(email);
        } catch (err) {
          console.error(err);
        }
      }

      // Load user dashboard info from the server
      async function loadDashboard(email) {
        try {
          const res = await fetch(appHost + '/api/dashboard?email=' + encodeURIComponent(email));
          if (!res.ok) {
            console.error('Failed to load dashboard');
            return;
          }
          const data = await res.json();
          document.getElementById('dashboard').classList.remove('hidden');
          // Populate summary cards
          document.getElementById('total-grams').textContent = data.totalGrams.toFixed(4);
          document.getElementById('total-value').textContent = '₹' + data.totalValue.toFixed(2);
          document.getElementById('redeemable-grams').textContent = data.redeemableGrams.toFixed(4);
          document.getElementById('current-grams').textContent = data.progress.current.toFixed(4);
          document.getElementById('next-milestone').textContent = data.progress.nextMilestone.toFixed(2);
          const percent = Math.min(100, Math.floor(data.progress.progressPercent * 100));
          document.getElementById('progress-bar').style.width = percent + '%';
          // Orders table
          const tbody = document.getElementById('orders-table');
          tbody.innerHTML = '';
          // Sort orders by date descending
          data.orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          data.orders.forEach((order) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="py-2 px-4">${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : ''}</td>
              <td class="py-2 px-4">${order.orderNumber || order.orderId}</td>
              <td class="py-2 px-4">${(order.rewardGrams || 0).toFixed(4)}</td>
            `;
            tbody.appendChild(tr);
          });
          // Shops grid
          const grid = document.getElementById('shops-grid');
          grid.innerHTML = '';
          data.shops.forEach((shop) => {
            const div = document.createElement('div');
            div.className = 'bg-white p-3 rounded shadow hover:shadow-md transition cursor-pointer';
            div.addEventListener('click', () => {
              if (shop.url) window.open(shop.url, '_blank');
            });
            div.innerHTML = `
              <div class="w-full h-24 bg-gray-200 mb-2 rounded overflow-hidden flex items-center justify-center">
                ${shop.image ? '<img src="' + shop.image + '" alt="' + shop.name + '" class="object-cover w-full h-full">' : '<span class="text-gray-400">No Image</span>'}
              </div>
              <h4 class="font-semibold text-center">${shop.name || ''}</h4>
              <p class="text-xs text-center text-gray-500">${shop.totalDistributed ? (shop.totalDistributed.toFixed(4) + ' g distributed') : ''}</p>
            `;
            grid.appendChild(div);
          });
          // Disable redemption button if there is no redeemable balance
          const redeemButton = document.querySelector('#redeem-form button[type="submit"]');
          if (data.redeemableGrams <= 0) {
            redeemButton.disabled = true;
            redeemButton.classList.add('opacity-50', 'cursor-not-allowed');
          } else {
            redeemButton.disabled = false;
            redeemButton.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        } catch (err) {
          console.error(err);
        }
      }

      // Handle redemption form submission
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('redeem-form');
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const grams = parseFloat(document.getElementById('redeem-grams').value);
          const upiId = document.getElementById('redeem-upi').value;
          if (!currentUserEmail) return;
          if (grams <= 0) {
            alert('Enter a positive amount of grams to redeem.');
            return;
          }
          try {
            const res = await fetch(appHost + '/api/redemptions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: currentUserEmail, grams, upiId }),
            });
            if (res.ok) {
              document.getElementById('redeem-message').classList.remove('hidden');
              await loadDashboard(currentUserEmail);
              form.reset();
              setTimeout(() => {
                document.getElementById('redeem-message').classList.add('hidden');
              }, 4000);
            } else {
              const data = await res.json();
              alert(data.error || 'Failed to submit redemption request');
            }
          } catch (err) {
            console.error(err);
            alert('Failed to submit redemption request');
          }
        });
      });

      // Sign out: reset UI and disable auto select
      document.getElementById('signout-btn').addEventListener('click', () => {
        currentUserEmail = null;
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('signout-btn').classList.add('hidden');
        document.getElementById('signin-container').classList.remove('hidden');
        google.accounts.id.disableAutoSelect();
      });
    </script>
  </body>
</html>